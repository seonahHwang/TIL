# 옵티마이저란

: SQL을 빠르고 효율적으로 수행할 최적의 처리경로를 생성해주는 DBMS 내부의 핵심 엔진

사용자가 구조화된 질의어(SQL)로 결과 집합을 요구하면

이를 생성하는데 필요한 처리경로는 DBMS에 내장된 옵티마이저가 자동으로 생성해준다 

### 실행계획

옵티마이저가 생성한 SQL 처리경로를 실행계획이라고한다

### 옵티마이저의 SQL 최적화 과정

1. 사용자가 던진 쿼리 수행을 위해 후보군이 될만한 실행계획을 찾는다
2. 데이터 딕셔너리에 미리 수집해놓은 오브젝트 통계 및 시스템 통계정보를 이용해 
    
    각 실행계획의 예상 비용 산정
    
3. 각 실행계획을 비교하여 최저비용을 갖는 하나를 선택한다 

## 옵티마이저 종류

- 규칙 기반 옵티마이저
- 비용 기반 옵티마이저

## 규칙기반 옵티마이저

실행 속도가 빠른 순으로 규칙을 세워두고 우선순위가 높은 방법을 채택하는 옵티마이저 

규칙이란?

→ 액세스 경로별 우선순위로서

인덱스 구조, 연산, 조건절 형태가 순위를 결정짓는 주요인이다

![스크린샷 2023-07-03 오후 1.49.02.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7610cd65-1387-46b4-a89f-1d5456fe57d1/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-07-03_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_1.49.02.png)

### 비용 기반 옵티마이저 (CBO : Cost-Based Optimizer)

비용 기반으로 최적화 수행

비용이란? 쿼리를 수행하는데 소요되는 일의 양 또는 시간

실행 계획을 최대 2천개까지 세운뒤 비용이 최소한으로 나온 실행계획을 수행

실행계획 수립할 때 판단 기준이 되는 비용은 예상치

따라서 CBO는 비용예측을 위해

테이블, 인덱스, 칼럼 등 다양한 객체 통계정보 및 시스템 통계정보(CPU 속도, 디스크 I/O 속도 등)를 이용한다

## 옵티마이저의 최적화 목표

### 1. 전체 처리속도 최적화

쿼리 최종 결과집합을 끝까지 읽는 것을 전제로 시스템 리소스를 가장 적게 사용하는 실행계획을 선택한다

대부분의 DBMS의 기본 옵티마이저 모드는 전체 처리속도 최적화에 맞춰져 있다

### 2. 최초 응답속도 최적화

전체 결과집합 중 일부만 읽다가 멈추는 것을 전제로 

가장 빠른 응답 속도를 낼 수 있는 실행계획을 선택한다 

만약 이 모드에서 생성한 실행계획으로 데이터를 끝까지 읽는다면 전체 처리속도 최적화 실행계획보다

더 많은 리소스를 사용하고 수행 속도도 느려질 수 있다 

## 옵티마이저 행동에 영향을 미치는 요소

1. SQL과 연산자 형태
    
    결과가 같더라도
    
    SQL을 어떤 형태로 작성했는지 또는 
    
    어떤 연산자를 사용했는지에 따라 옵티마이저가 다른 선택을 할 수 있다.
    
2. 옵티파이징 팩터
    
    쿼리를 똑같이 작성하더라도 인덱스, IOT, 클러스터링, 파티셔닝 등을 어떻게 구성했는지에 따라
    
    실행계획과 성능이 크게 달라진다 
    
3. DBMS 제약 설정
    
    개체 무결성, 참조 무결성, 도메인 무결성 등을 위해 DBMS가 제공하는 PK, FK, Check, Not null 같은 제약 설정 기능을 이용할 수 있고, 이들 제약 설정은 옵티마이저가 쿼리 성능을 최적화하는데 매우 중요한 정보 제공
    
    예를 들어 인덱스 칼럼에 Not null 제약이 설정되어 있으면 
    
    옵티마이저는 전체 개수를 구하는 Count 쿼리에 이 인덱스를 활용할 수 있다
    

1. 옵티마이저 힌트
    
    옵티마이저의 판단보다 사용자가 지정한 옵티마이저 힌트가 우선한다
    
2. 통계 정보
    
    통계정보가 옵티마이저에게 미치는 영향력은 절대적이다
    
    CBO의 모든 판단 기준은 통계정보에서 나온다
    
    ![주요 통계 정보 ](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c7b86e7e-80ea-4abf-a57c-329f92cc7278/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-07-05_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_12.07.33.png)
    
    주요 통계 정보 
    
    1. 옵티마이저 관련 파라미터
        
        SQL, 데이터, 통계정보, 하드웨어 등 모든 환경이 동일하더라도 DBMS 버전을 업그레이드하면
        
        옵티마이저가 다르게 작동될 수 있다
        
        이는 옵티마이저 관련 파라미터가 추가 또는 변경되면서 나타나는 현상이다 
        
    2. DBMS 버전과 종류
        
        옵티마이저 관련 파라미터가 같더라도 버전에 따라 실행계획이 다를 수 있다.
        
        또한 같은 SQL 이더라도 DBMS 종류에 따라 내부적으로 처리하는 방식이 다를 수 있다 
        
    
    ## 옵티마이저의 한계
    
    1. 옵티마이징 팩터의 부족
    2. 통계정보의 부정확성
    3. 바인드 변수 사용 시 균등 분포 가정 
        
        `바인드 변수(비 PL/SQL 변수)`
        
        ▷ PL/SQL 외부에서도 사용할 수 있는 변수.
        
        ▷ 호스트 환경에서 생성되어 데이터를 저장하기 때문에 호스트 변수라고 한다.
        
        ▷ 키워드 VARIABLE을 이용하며, SQL문이나 PL/SQL블록에서도 사용 가능하다.
        
        ▷ PL/SQL블록이 실행된 후에도 액세스가 가능하다.
        
        ▷ print명령을 이용하여 출력이 가능하다.
        
        ▷ :(콜론) 을 붙여 사용한다.
        
        ```sql
        begin
        select SAL*12+nvl(comm*12,0) into :vsal
        from EMP
        where EMPNO = 7369;
        end;
        print VSAL;
        ```
        
    
    1. 규칙에 의존하는 CBO
        
        아무리 비용 기반 옵티마이저라 해도 부분적으로는 규칙에 의존
        
        ex) 최적화 목표를 최초 응답속도에 맞추면 order by 소트를 대체할 인덱스가 있을때 무조건 그 인덱스 사용 
        
    2. 하드웨어 성능
